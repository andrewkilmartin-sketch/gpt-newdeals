# Error Log - 2026-01-10

## Summary
This document records all bugs fixed on 2026-01-10 that were causing production failures. Multiple issues were incorrectly blamed on deployment/caching when they were code bugs.

---

## Production Failures Timeline

### Session 1-4: Repeated Failures
- **Symptom:** `/shopping/awin-link` endpoint timeout (18+ seconds)
- **Initial diagnosis:** "Railway deployment cache", "production environment differences"
- **Actual cause:** Code bugs in database query optimization

### Session 5: Root Cause Identified
- **Fix #27:** `checkBrandExistsInDB()` used ILIKE on 1.1M rows without index
- **Fix #28:** `storage.searchProducts()` called OpenAI API before fast path

---

## Bugs Fixed (28 Total)

### Critical Performance Bugs

| Fix # | Issue | Impact | Solution |
|-------|-------|--------|----------|
| 27 | `checkBrandExistsInDB` hanging | 18s+ timeout | Use tsvector instead of ILIKE |
| 28 | `searchProducts` slow path first | 5-10s OpenAI delay | TSVECTOR ULTRA FAST PATH runs first |
| 20 | ILIKE on 1.1M products | 8-15s per query | tsvector + GIN index |
| 24 | Age query ILIKE category filter | 4.4s delay | tsvector for category filter |

### Search Relevance Bugs

| Fix # | Issue | Impact | Solution |
|-------|-------|--------|----------|
| 1 | Substring matching | "bike" → "biker coat" | Word boundary regex `~* '\yword\y'` |
| 5 | Character names not found | "Hulk" → 0 results | Check BOTH brand AND name |
| 7 | Character query wrong products | "spiderman" → dog toys | Inject character into searchTerms |
| 9 | Character brand filter blocks | "frozen" → 0 results | Remove hardcoded brand filters |
| 10 | Witch costume wrong results | Returned Harry Potter | WICKED_WITCH character priority |
| 12 | Book queries return bags | "peppa books" → backpacks | filterForBooksContext() |
| 14 | Costume filter too broad | Returned Barbie dolls | COSTUME_NON_WEARABLE_TERMS |
| 22 | Relevance sorting missing | Random order | Keyword match sorting |
| 23 | LOL dolls timeout | 60s timeout | Known brand fast path |

### Production Compatibility Bugs

| Fix # | Issue | Impact | Solution |
|-------|-------|--------|----------|
| 25-26 | Missing search_vector column | 500 errors in production | try/catch with ILIKE fallback |

---

## Performance Results

### Before Fixes
| Endpoint | Response Time |
|----------|---------------|
| `/shopping/awin-link?query=lego` | 18s+ timeout |
| `/shopping/awin-link?query=barbie` | 18s+ timeout |
| Age-based queries | 4-10s |
| Brand queries | 8-15s |

### After Fixes
| Endpoint | Cold | Warm (Cached) |
|----------|------|---------------|
| `/shopping/awin-link?query=lego` | 0.86s | 65ms |
| `/shopping/awin-link?query=barbie` | 0.86s | 65ms |
| Age-based queries | 137ms | 137ms |
| Brand queries | 78ms | 78ms |

---

## Root Cause Analysis

### Why Deployment Was Blamed (Incorrectly)

1. **Local vs Production discrepancy:** Development DB had `search_vector` column, production didn't
2. **No fallback code:** Queries failed silently when column missing
3. **Insufficient logging:** Couldn't tell which code path executed
4. **Assumption:** "If it works locally, it's a deployment issue"

### What Should Have Been Done

1. Test production endpoint directly: `curl https://production-url/endpoint`
2. Check production logs for actual errors
3. Add try/catch with fallbacks for all database operations
4. Log which code path is executing

---

## Files Modified

| File | Changes |
|------|---------|
| `server/routes.ts` | 26 bug fixes, tsvector search, fallbacks |
| `server/storage.ts` | TSVECTOR ULTRA FAST PATH, early return |
| `server/services/awin.ts` | checkBrandExistsInDB tsvector fix |
| `CRITICAL_FIXES.md` | Documentation of all 28 fixes |
| `shared/schema.ts` | No changes (search_vector via raw SQL) |

---

## Verification

Production endpoint tested and working:
```bash
curl "https://gpt-newdeals-production.up.railway.app/shopping/awin-link?query=lego"
# Response: 10 results in 1.8s
```

All 9 regression test queries pass:
- lego: 78ms
- barbie: 78ms
- paw patrol toys: 77ms
- spiderman toys: 61ms
- hot wheels cars: 105ms
- witch costume: 91ms
- lol dolls: 55ms
- toys for 5 year old: 137ms
- dinosaur figures: 124ms
