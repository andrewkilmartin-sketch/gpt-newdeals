
Read CRITICAL_FIXES.md, REPLIT_FIX_INSTRUCTIONS.md, and STOP_BLAMING_INVENTORY.md. Tell me what fixes are logged.
Build a click tracking system to log every product click. This data is essential for future improvements.
Step 1: Create database table for click logs
sqlCREATE TABLE IF NOT EXISTS click_logs (
  id SERIAL PRIMARY KEY,
  session_id VARCHAR(255),
  query VARCHAR(500),
  product_id VARCHAR(255),
  product_name VARCHAR(500),
  product_price DECIMAL(10,2),
  product_merchant VARCHAR(255),
  position INTEGER,
  products_shown_count INTEGER,
  products_shown_ids TEXT,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  time_on_page_ms INTEGER,
  destination_url TEXT,
  device_type VARCHAR(50),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_click_logs_query ON click_logs(query);
CREATE INDEX idx_click_logs_product_id ON click_logs(product_id);
CREATE INDEX idx_click_logs_timestamp ON click_logs(timestamp);
Step 2: Create API endpoint to log clicks
Create POST /api/track/click endpoint:
typescript// In server/routes.ts

app.post('/api/track/click', async (req, res) => {
  try {
    const {
      session_id,
      query,
      product_id,
      product_name,
      product_price,
      product_merchant,
      position,
      products_shown_count,
      products_shown_ids,
      time_on_page_ms,
      destination_url,
      device_type
    } = req.body;

    await db.insert(clickLogs).values({
      session_id: session_id || 'anonymous',
      query: query || '',
      product_id: product_id || '',
      product_name: product_name || '',
      product_price: product_price || 0,
      product_merchant: product_merchant || '',
      position: position || 0,
      products_shown_count: products_shown_count || 0,
      products_shown_ids: JSON.stringify(products_shown_ids || []),
      time_on_page_ms: time_on_page_ms || 0,
      destination_url: destination_url || '',
      device_type: device_type || 'unknown'
    });

    res.json({ success: true });
  } catch (error) {
    console.error('Click tracking error:', error);
    res.json({ success: false });
  }
});
Step 3: Create schema for click_logs table
Add to shared/schema.ts:
typescriptexport const clickLogs = pgTable('click_logs', {
  id: serial('id').primaryKey(),
  sessionId: varchar('session_id', { length: 255 }),
  query: varchar('query', { length: 500 }),
  productId: varchar('product_id', { length: 255 }),
  productName: varchar('product_name', { length: 500 }),
  productPrice: decimal('product_price', { precision: 10, scale: 2 }),
  productMerchant: varchar('product_merchant', { length: 255 }),
  position: integer('position'),
  productsShownCount: integer('products_shown_count'),
  productsShownIds: text('products_shown_ids'),
  timestamp: timestamp('timestamp', { withTimezone: true }).defaultNow(),
  timeOnPageMs: integer('time_on_page_ms'),
  destinationUrl: text('destination_url'),
  deviceType: varchar('device_type', { length: 50 }),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow()
});
Step 4: Update frontend to track clicks
When user clicks a product, call the tracking endpoint BEFORE redirecting:
typescriptasync function trackAndRedirect(product, query, position, allProducts) {
  // Track the click
  await fetch('/api/track/click', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      session_id: getSessionId(),
      query: query,
      product_id: product.id,
      product_name: product.name,
      product_price: product.price,
      product_merchant: product.merchant,
      position: position,
      products_shown_count: allProducts.length,
      products_shown_ids: allProducts.map(p => p.id),
      time_on_page_ms: Date.now() - pageLoadTime,
      destination_url: product.affiliateUrl,
      device_type: detectDevice()
    })
  });

  // Then redirect to affiliate link
  window.location.href = product.affiliateUrl;
}

function getSessionId() {
  let sessionId = localStorage.getItem('sunny_session_id');
  if (!sessionId) {
    sessionId = 'sess_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('sunny_session_id', sessionId);
  }
  return sessionId;
}

function detectDevice() {
  const ua = navigator.userAgent;
  if (/mobile/i.test(ua)) return 'mobile';
  if (/tablet/i.test(ua)) return 'tablet';
  return 'desktop';
}
Step 5: Create analysis endpoint
Create GET /api/track/analysis to review click patterns:
typescriptapp.get('/api/track/analysis', async (req, res) => {
  try {
    // Products shown but never clicked (potential bad results)
    const neverClicked = await db.execute(sql`
      SELECT query, product_name, COUNT(*) as times_shown
      FROM click_logs
      WHERE product_id NOT IN (
        SELECT DISTINCT product_id FROM click_logs WHERE position IS NOT NULL
      )
      GROUP BY query, product_name
      ORDER BY times_shown DESC
      LIMIT 50
    `);

    // Queries where users click result #3+ instead of #1 (ranking issues)
    const rankingIssues = await db.execute(sql`
      SELECT query, AVG(position) as avg_click_position, COUNT(*) as click_count
      FROM click_logs
      WHERE position > 2
      GROUP BY query
      HAVING COUNT(*) > 5
      ORDER BY avg_click_position DESC
      LIMIT 50
    `);

    // Most clicked products per query (what users actually want)
    const topChoices = await db.execute(sql`
      SELECT query, product_name, COUNT(*) as clicks
      FROM click_logs
      GROUP BY query, product_name
      ORDER BY clicks DESC
      LIMIT 100
    `);

    res.json({
      never_clicked: neverClicked.rows,
      ranking_issues: rankingIssues.rows,
      top_choices: topChoices.rows
    });
  } catch (error) {
    console.error('Analysis error:', error);
    res.status(500).json({ error: 'Analysis failed' });
  }
});
Step 6: Create daily summary script
Create scripts/click-analysis-daily.ts:
typescriptimport { db } from '../server/db';
import { sql } from 'drizzle-orm';

async function dailyClickAnalysis() {
  console.log('=== DAILY CLICK ANALYSIS ===\n');

  // Total clicks today
  const today = await db.execute(sql`
    SELECT COUNT(*) as total_clicks,
           COUNT(DISTINCT query) as unique_queries,
           COUNT(DISTINCT session_id) as unique_sessions
    FROM click_logs
    WHERE timestamp > NOW() - INTERVAL '24 hours'
  `);
  console.log('Today:', today.rows[0]);

  // Products shown 10+ times but clicked 0 times = BAD RESULTS
  const badResults = await db.execute(sql`
    WITH shown AS (
      SELECT query, product_name, COUNT(*) as times_shown
      FROM click_logs
      GROUP BY query, product_name
    ),
    clicked AS (
      SELECT query, product_name, COUNT(*) as times_clicked
      FROM click_logs
      WHERE position IS NOT NULL
      GROUP BY query, product_name
    )
    SELECT s.query, s.product_name, s.times_shown, COALESCE(c.times_clicked, 0) as times_clicked
    FROM shown s
    LEFT JOIN clicked c ON s.query = c.query AND s.product_name = c.product_name
    WHERE s.times_shown >= 10 AND COALESCE(c.times_clicked, 0) = 0
    ORDER BY s.times_shown DESC
    LIMIT 20
  `);
  
  console.log('\n=== BAD RESULTS (shown 10+ times, never clicked) ===');
  badResults.rows.forEach(r => {
    console.log(`  "${r.query}" → "${r.product_name}" (shown ${r.times_shown}x, clicked 0x)`);
  });

  // Queries where avg click position > 3 = RANKING ISSUES
  const rankingIssues = await db.execute(sql`
    SELECT query, ROUND(AVG(position), 1) as avg_position, COUNT(*) as clicks
    FROM click_logs
    WHERE position IS NOT NULL
    GROUP BY query
    HAVING AVG(position) > 3 AND COUNT(*) >= 5
    ORDER BY AVG(position) DESC
    LIMIT 20
  `);
  
  console.log('\n=== RANKING ISSUES (users clicking past result #3) ===');
  rankingIssues.rows.forEach(r => {
    console.log(`  "${r.query}" → avg click position: ${r.avg_position} (${r.clicks} clicks)`);
  });

  console.log('\n=== ANALYSIS COMPLETE ===');
}

dailyClickAnalysis().catch(console.error);
After building:

Run the SQL to create the table
Test the tracking endpoint works
Deploy to Railway
After 1 week of data, run the analysis script

This gives us real user feedback to improve search, not just our test queries.
Update CRITICAL_FIXES.md with Fix #42 - Click Tracking System.