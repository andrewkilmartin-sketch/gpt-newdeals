import express, { Router, Request, Response } from 'express';
import OpenAI from 'openai';

const router: Router = express.Router();

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

const API_BASE = process.env.API_BASE_URL || 'http://localhost:5000';

const KIDS_PASS_LINKS: Record<string, { url: string; discount: string; description: string }> = {
  'safari': { url: 'https://www.kidspass.co.uk/safari-parks', discount: 'up to 40%', description: 'safari parks, wildlife parks and zoos' },
  'zoo': { url: 'https://www.kidspass.co.uk/zoos', discount: 'up to 40%', description: 'zoos and wildlife attractions' },
  'theme-park': { url: 'https://www.kidspass.co.uk/theme-parks', discount: 'up to 35%', description: 'theme parks and adventure parks' },
  'cinema': { url: 'https://www.kidspass.co.uk/cinema', discount: 'up to 40%', description: 'cinema tickets at Odeon, Vue, Cineworld and more' },
  'indoor': { url: 'https://www.kidspass.co.uk/indoor-activities', discount: 'up to 50%', description: 'soft play, trampoline parks and indoor attractions' },
  'outdoor': { url: 'https://www.kidspass.co.uk/outdoor-activities', discount: 'up to 40%', description: 'outdoor attractions and adventures' },
  'aquarium': { url: 'https://www.kidspass.co.uk/aquariums', discount: 'up to 35%', description: 'SEA LIFE centres and aquariums' },
  'restaurant': { url: 'https://www.kidspass.co.uk/restaurants', discount: 'up to 50%', description: 'family restaurants with kids eat free deals' },
  'default': { url: 'https://www.kidspass.co.uk', discount: 'up to 50%', description: 'thousands of family attractions' }
};

interface Intent {
  type: string;
  confidence: number;
  parameters: { query?: string; location?: string; category?: string; limit?: number; };
}

interface Classification {
  intents: Intent[];
}

interface UpsellCategory {
  keywords: string[];
  searchTerms: string[];
  pitch: string;
}

const UPSELL_CATEGORIES: Record<string, UpsellCategory> = {
  'safari': { keywords: ['safari', 'zoo', 'wildlife', 'animal', 'animals'], searchTerms: ['binoculars kids', 'safari toys', 'animal figures'], pitch: 'Road trip essentials' },
  'theme-park': { keywords: ['theme park', 'theme parks', 'roller coaster', 'alton towers', 'thorpe park', 'amusement'], searchTerms: ['sun hat kids', 'water bottle children', 'portable charger'], pitch: 'Theme park must-haves' },
  'cinema': { keywords: ['cinema', 'pictures', 'odeon', 'vue', 'cineworld', 'movie theatre'], searchTerms: ['popcorn', 'cinema snacks', 'sweets'], pitch: 'Cinema treats' },
  'movie-night': { keywords: ['netflix', 'disney+', 'disney plus', 'film at home', 'night in', 'streaming', 'watch at home', 'prime video'], searchTerms: ['popcorn maker', 'blanket kids', 'pyjamas kids', 'bean bag'], pitch: 'Movie night essentials' },
  'rainy-day': { keywords: ['bored', 'rainy', 'indoor', 'stuck inside', 'nothing to do'], searchTerms: ['craft kit kids', 'board game family', 'puzzle kids', 'play dough'], pitch: 'Keep them busy' },
  'beach': { keywords: ['beach', 'seaside', 'coast', 'swimming'], searchTerms: ['bucket spade', 'beach toys', 'swimming goggles kids'], pitch: 'Beach day essentials' },
  'party': { keywords: ['party', 'birthday', 'celebration'], searchTerms: ['party bags kids', 'birthday decorations', 'party games'], pitch: 'Party supplies' }
};

const ENDPOINTS: Record<string, string> = {
  ATTRACTION: '/attractions/search',
  CINEMA: '/cinema/search',
  HOME_MOVIE: '/nightin/search',
  ACTIVITY: '/activities/search',
  SHOPPING: '/shopping/awin-link',
  TIPS: '/hintsandtips/search'
};

function getKidsPassPromo(intents: Intent[], query: string) {
  const queryLower = query.toLowerCase();
  const hasAttractionIntent = intents.some(i => i.type === 'ATTRACTION' || i.type === 'CINEMA');
  if (!hasAttractionIntent) return null;
  
  // Safari / Wildlife
  if (queryLower.includes('safari') || queryLower.includes('wildlife')) {
    return { promo: KIDS_PASS_LINKS['safari'], category: 'safari' };
  }
  
  // Zoo / Animals
  if (queryLower.includes('zoo') || queryLower.includes('animal')) {
    return { promo: KIDS_PASS_LINKS['zoo'], category: 'zoo' };
  }
  
  // Theme Parks
  if (queryLower.includes('theme park') || queryLower.includes('theme parks') || 
      queryLower.includes('alton') || queryLower.includes('thorpe') || 
      queryLower.includes('legoland') || queryLower.includes('chessington') ||
      queryLower.includes('amusement') || queryLower.includes('roller coaster')) {
    return { promo: KIDS_PASS_LINKS['theme-park'], category: 'theme-park' };
  }
  
  // Cinema
  if (queryLower.includes('cinema') || queryLower.includes('pictures') || 
      queryLower.includes('film showing') || queryLower.includes('movie theatre')) {
    return { promo: KIDS_PASS_LINKS['cinema'], category: 'cinema' };
  }
  
  // Indoor activities
  if (queryLower.includes('soft play') || queryLower.includes('trampoline') || 
      queryLower.includes('indoor play') || queryLower.includes('play centre') ||
      queryLower.includes('play center') || queryLower.includes('bounce') ||
      queryLower.includes('ball pit') || queryLower.includes('climbing wall')) {
    return { promo: KIDS_PASS_LINKS['indoor'], category: 'indoor' };
  }
  
  // Aquarium
  if (queryLower.includes('aquarium') || queryLower.includes('sea life') || 
      queryLower.includes('sealife') || queryLower.includes('fish')) {
    return { promo: KIDS_PASS_LINKS['aquarium'], category: 'aquarium' };
  }
  
  // Restaurants
  if (queryLower.includes('restaurant') || queryLower.includes('eat') || 
      queryLower.includes('lunch') || queryLower.includes('dinner') ||
      queryLower.includes('food') || queryLower.includes('dining') ||
      queryLower.includes('meal') || queryLower.includes('hungry')) {
    return { promo: KIDS_PASS_LINKS['restaurant'], category: 'restaurant' };
  }
  
  return { promo: KIDS_PASS_LINKS['default'], category: 'default' };
}

function detectUpsellCategory(query: string, intents: Intent[]): UpsellCategory | null {
  const queryLower = query.toLowerCase();
  for (const [, config] of Object.entries(UPSELL_CATEGORIES)) {
    if (config.keywords.some(kw => queryLower.includes(kw))) return config;
  }
  const intentTypes = intents.map(i => i.type);
  if (intentTypes.includes('HOME_MOVIE')) return UPSELL_CATEGORIES['movie-night'];
  if (intentTypes.includes('ACTIVITY')) return UPSELL_CATEGORIES['rainy-day'];
  return null;
}

async function fetchSmartUpsells(category: UpsellCategory | null): Promise<any[]> {
  if (!category) return [];
  try {
    const searchTerm = category.searchTerms[Math.floor(Math.random() * category.searchTerms.length)];
    const response = await fetch(`${API_BASE}/shopping/awin-link?query=${encodeURIComponent(searchTerm)}&limit=2`);
    const data = await response.json();
    return data.results || [];
  } catch { return []; }
}

async function classifyIntent(userMessage: string): Promise<Classification> {
  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `You classify user messages for a UK family concierge. Return JSON only.

INTENTS (pick ALL that apply):
- ATTRACTION: Days out, theme parks, zoos, safari parks, aquariums, museums, soft play, trampoline parks, restaurants, dining, bowling, escape rooms, farms, castles
- CINEMA: "What's on at the cinema", "films showing", cinema times, movie times
- HOME_MOVIE: Streaming at home, Netflix, Disney+, "film for tonight", "watch at home", "night in", "movie night at home"
- ACTIVITY: Kids activities at home, "bored", rainy day, crafts, games, things to do at home
- SHOPPING: Products, toys, clothes, gifts, presents, buying things
- TIPS: Money saving advice, budgeting
- GREETING: Just hello/hi with no other request

IMPORTANT DISTINCTIONS:
- "film for tonight" or "film at home" or "netflix" = HOME_MOVIE (not CINEMA)
- "what's on at the cinema" or "film showing near me" = CINEMA (not HOME_MOVIE)
- "soft play" or "restaurants" or "trampoline park" = ATTRACTION
- "bored at home" or "rainy day activities" = ACTIVITY
- "buy birthday present" = SHOPPING

Extract parameters:
- query: search terms only (not full sentence)
- location: city/area if mentioned
- category: specific type if mentioned
- limit: default 5

Return: {"intents":[{"type":"...","confidence":0.9,"parameters":{"query":"...","location":"..."}}]}`
        },
        { role: 'user', content: userMessage }
      ],
      response_format: { type: 'json_object' },
      temperature: 0.1
    });
    return JSON.parse(response.choices[0].message.content || '{"intents":[]}');
  } catch (error) {
    console.error('Classification error:', error);
    return { intents: [{ type: 'GREETING', confidence: 1, parameters: {} }] };
  }
}

async function fetchData(intent: Intent): Promise<any> {
  const endpoint = ENDPOINTS[intent.type];
  if (!endpoint) return null;

  const params = new URLSearchParams();
  const p = intent.parameters;
  
  if (intent.type === 'CINEMA') {
    if (p.category) params.append('genre', p.category);
    if (p.location) params.append('location', p.location);
  } else if (intent.type === 'HOME_MOVIE') {
    const serviceMap: Record<string, string> = { 
      'netflix': 'Netflix', 
      'disney+': 'Disney+', 
      'disney plus': 'Disney+', 
      'prime': 'Prime Video', 
      'amazon prime': 'Prime Video',
      'now tv': 'NOW',
      'apple': 'Apple TV+'
    };
    const moodMap: Record<string, string> = { 
      'scary': 'Scary', 
      'funny': 'Fun', 
      'family': 'Heartwarming', 
      'kids': 'Fun',
      'adventure': 'Adventure',
      'animated': 'Fun'
    };
    if (p.query) {
      const qLower = p.query.toLowerCase();
      for (const [key, value] of Object.entries(serviceMap)) { 
        if (qLower.includes(key)) { params.append('service', value); break; } 
      }
      for (const [key, value] of Object.entries(moodMap)) { 
        if (qLower.includes(key)) { params.append('mood', value); break; } 
      }
    }
  } else if (intent.type === 'ACTIVITY') {
    if (p.query) {
      const qLower = p.query.toLowerCase();
      if (qLower.includes('indoor') || qLower.includes('inside') || qLower.includes('home')) {
        params.append('setting', 'INDOOR');
      }
      if (qLower.includes('outdoor') || qLower.includes('outside') || qLower.includes('garden')) {
        params.append('setting', 'OUTDOOR');
      }
      const ageMatch = qLower.match(/(\d+)\s*(year|yr|yo)/);
      if (ageMatch) params.append('age', ageMatch[1]);
    }
  } else if (intent.type === 'SHOPPING') {
    if (p.query) params.append('query', p.query);
    params.append('limit', '3');
  } else {
    if (p.query) params.append('query', p.query);
    if (p.category) params.append('category', p.category);
    if (p.location) params.append('location', p.location);
  }
  
  if (intent.type !== 'SHOPPING') {
    params.append('limit', String(p.limit || 5));
  }

  try {
    const url = `${API_BASE}${endpoint}?${params.toString()}`;
    console.log(`[Sunny] FETCHING FROM API: ${url}`);
    const response = await fetch(url);
    const data = await response.json();
    console.log(`[Sunny] API RETURNED ${data.results?.length || 0} results`);
    if (data.results?.length > 0) {
      console.log(`[Sunny] API RESULT NAMES: ${data.results.map((r: any) => r.name || r.title).join(', ')}`);
    }
    return { type: intent.type, results: data.results || [], count: data.count || 0 };
  } catch (error) {
    console.error(`[Sunny] API FETCH ERROR for ${intent.type}:`, error);
    return { type: intent.type, results: [], count: 0 };
  }
}

async function generateResponse(userMessage: string, results: any[], kidsPassPromo: any, upsells: any[], showFoodDeals: boolean): Promise<string> {
  const hasResults = results.some(r => r.results && r.results.length > 0);
  
  if (!hasResults) {
    return "I couldn't find anything matching that in our database right now. Could you try:\n- Being more specific (e.g., 'zoos near London')\n- A different category\n\nI can help with days out, cinema, films at home, activities, and shopping deals!";
  }

  const availableNames: string[] = [];
  results.forEach(r => {
    if (r.results) {
      r.results.forEach((item: any) => {
        if (item.name) availableNames.push(item.name);
        if (item.title) availableNames.push(item.title);
      });
    }
  });

  const response = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [
      {
        role: 'system',
        content: `You are Sunny, a friendly family concierge for Kids Pass UK.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CRITICAL ANTI-HALLUCINATION RULES - READ CAREFULLY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

You can ONLY mention these exact names (copy/paste exactly):
${availableNames.map((n, i) => `${i + 1}. ${n}`).join('\n')}

DO NOT mention ANY attraction, film, or venue that is not in the list above.
DO NOT substitute similar names (e.g., if "West Midland Safari" is listed, don't say "Longleat")
DO NOT guess or invent - only use what's listed above.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

RESPONSE STRUCTURE:

${kidsPassPromo ? `1. START WITH: "üéüÔ∏è **Kids Pass members save ${kidsPassPromo.promo.discount}** on ${kidsPassPromo.promo.description}! [Browse deals](${kidsPassPromo.promo.url})"

2. THEN:` : '1.'} Present 3-5 items from the list above with brief descriptions (use info from <api_data>)

${upsells.length > 0 ? `3. Mention ONE product: "${upsells[0]?.name || 'Check out our deals'}"` : ''}

${showFoodDeals ? `4. Add: "üçï Make it a movie night - order in with Uber Eats!"` : ''}

FINALLY: Ask a friendly follow-up question

<api_data>
${JSON.stringify(results, null, 2)}
</api_data>

<upsells>
${JSON.stringify(upsells, null, 2)}
</upsells>

TONE: Warm, helpful, like a friend who knows all the best family spots. Use emojis sparingly.
LENGTH: Keep it concise - parents are busy!`
      },
      { role: 'user', content: userMessage }
    ],
    temperature: 0.3
  });

  return response.choices[0].message.content || "Sorry, I had trouble generating a response. Please try again.";
}

router.get('/health', (req: Request, res: Response) => {
  res.json({ 
    status: 'Sunny v2.2 - Enhanced Anti-Hallucination', 
    version: 'v2.2',
    timestamp: new Date().toISOString() 
  });
});

router.post('/chat', async (req: Request, res: Response) => {
  try {
    const { message } = req.body;
    if (!message || message.trim() === '') {
      return res.status(400).json({ error: 'Message required', success: false });
    }

    console.log(`\n[Sunny] ========== NEW REQUEST ==========`);
    console.log(`[Sunny] USER MESSAGE: "${message}"`);

    const classification = await classifyIntent(message);
    console.log(`[Sunny] INTENTS: ${classification.intents.map(i => i.type).join(', ')}`);

    if (classification.intents.length === 1 && classification.intents[0].type === 'GREETING') {
      return res.json({
        success: true,
        response: "Hey there! üëã I'm Sunny, your family day-out helper.\n\nI can find you:\nüé¢ **Days out** (with Kids Pass savings!)\nüé¨ **Cinema** times & deals\nüçø **Films at home** for movie night\nüé® **Activities** for rainy days\nüõçÔ∏è **Shopping** deals\n\nWhat are you looking for today?",
        debug: { intents: classification.intents }
      });
    }

    const kidsPassPromo = getKidsPassPromo(classification.intents, message);
    
    const results = await Promise.all(
      classification.intents.filter(i => ENDPOINTS[i.type]).map(intent => fetchData(intent))
    );

    const upsellCategory = detectUpsellCategory(message, classification.intents);
    const upsells = await fetchSmartUpsells(upsellCategory);
    const showFoodDeals = classification.intents.some(i => i.type === 'HOME_MOVIE');

    const response = await generateResponse(message, results, kidsPassPromo, upsells, showFoodDeals);

    console.log(`[Sunny] FINAL RESPONSE LENGTH: ${response.length} chars`);

    res.json({
      success: true,
      response,
      debug: {
        version: 'v2.2',
        intents: classification.intents,
        apiResults: results.map(r => ({ 
          type: r?.type, 
          count: r?.count, 
          names: r?.results?.map((x: any) => x.name || x.title) || []
        })),
        kidsPassPromo: kidsPassPromo?.category,
        upsellCategory: upsellCategory?.pitch,
        upsellCount: upsells.length
      }
    });

  } catch (error) {
    console.error('[Sunny] ERROR:', error);
    res.status(500).json({ 
      success: false, 
      error: 'Internal server error',
      response: "Oops! Something went wrong on my end. Please try again in a moment." 
    });
  }
});

export default router;
