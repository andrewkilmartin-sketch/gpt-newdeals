/**

- SUNNY AI FAMILY CONCIERGE v4.0
- Production-ready rewrite - simplified, conversational, revenue-optimized
- 
- INSTALLATION:
- 1. Replace your existing server/sunny.ts with this file
- 1. Restart your Replit server
- 1. Test with: curl -X POST localhost:5000/sunny/chat -H â€œContent-Type: application/jsonâ€ -d â€˜{â€œmessageâ€:â€œzoos near Manchesterâ€}â€™
- 
- CHANGES FROM v3:
- - System prompt reduced from 4000+ words to ~400 words
- - Removed rigid output formatting - let GPT be natural
- - Added sponsor strip for passive Awin revenue
- - Simplified tool execution flow
- - Removed vague query preprocessing - let AI handle naturally
    */

import OpenAI from â€œopenaiâ€;
import { db } from â€œ./dbâ€;
import { chatLogs } from â€œ@shared/schemaâ€;
import { v4 as uuidv4 } from â€œuuidâ€;

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// ============================================================================
// SYSTEM PROMPT - Keep this SHORT. Trust the model.
// ============================================================================

const SYSTEM_PROMPT = `You are Sunny, a warm and helpful family concierge for UK families.

PERSONALITY:
Youâ€™re like a friend whoâ€™s done it all with their own kids - genuine, a bit tired, but always helpful. Use 1-2 emojis max. No headers or bullet lists unless showing multiple options. Just talk naturally.

YOUR DATA:
You have tools that search REAL databases. Only recommend what the tools return - never invent venues, products, or links. If a search returns nothing, say so honestly.

MONETISATION (be natural, not salesy):

- Kids Pass: When recommending paid attractions, mention â€œKids Pass gets you X% offâ€ with the link. Frame it as saving money, not selling.
- Awin Products: If a product genuinely helps their situation (e.g. binoculars for zoo, snacks for cinema), mention ONE relevant product from search_products. Donâ€™t force it.

CONVERSATION STYLE:

- Answer what they asked first
- If something would genuinely help, mention it naturally
- Ask a follow-up question to keep them engaged
- Keep responses under 150 words unless they need more detail

LOCATION HANDLING:
If they say â€œnear meâ€ without a location, just ask â€œWhat area are you in?â€

KIDS PASS LINKS:

- Zoos: https://www.kidspass.co.uk/zoos
- Theme Parks: https://www.kidspass.co.uk/theme-parks
- Cinema: https://www.kidspass.co.uk/cinema
- Soft Play: https://www.kidspass.co.uk/indoor-activities
- Restaurants: https://www.kidspass.co.uk/restaurants
- General: https://www.kidspass.co.uk

Remember: Youâ€™re a helpful mate, not a salesperson. The best upsell is one that genuinely makes their day better.`;

// ============================================================================
// TOOL DEFINITIONS - Simplified, let GPT figure out when to use them
// ============================================================================

const tools: OpenAI.Chat.Completions.ChatCompletionTool[] = [
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_attractionsâ€,
description: â€œSearch paid UK attractions - theme parks, zoos, safari parks, aquariums, soft play, bowling, museums. Use for any â€˜days outâ€™ or â€˜things to doâ€™ queries.â€,
parameters: {
type: â€œobjectâ€,
properties: {
query: { type: â€œstringâ€, description: â€œWhat theyâ€™re looking for: zoo, theme park, soft play, bowling, museum, farm, etc.â€ },
location: { type: â€œstringâ€, description: â€œCity or areaâ€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 5â€ }
},
required: [â€œqueryâ€]
}
}
},
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_attractions_freeâ€,
description: â€œSearch FREE UK attractions - parks, museums, galleries, beaches. Use when they mention â€˜freeâ€™, â€˜cheapâ€™, or â€˜budgetâ€™.â€,
parameters: {
type: â€œobjectâ€,
properties: {
query: { type: â€œstringâ€, description: â€œWhat theyâ€™re looking forâ€ },
location: { type: â€œstringâ€, description: â€œCity or areaâ€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 5â€ }
},
required: [â€œqueryâ€]
}
}
},
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_cinemaâ€,
description: â€œFind films currently showing at UK cinemas.â€,
parameters: {
type: â€œobjectâ€,
properties: {
genre: { type: â€œstringâ€, description: â€œfamily, animation, comedy, actionâ€ },
family: { type: â€œbooleanâ€, description: â€œtrue for U/PG onlyâ€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 5â€ }
}
}
}
},
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_streamingâ€,
description: â€œFind films to watch at home on Netflix, Disney+, Prime Video, etc.â€,
parameters: {
type: â€œobjectâ€,
properties: {
service: { type: â€œstringâ€, description: â€œNetflix, Disney+, Prime Video, NOW, Skyâ€ },
mood: { type: â€œstringâ€, description: â€œFun, Heartwarming, Adventure, Scaryâ€ },
family: { type: â€œbooleanâ€, description: â€œtrue for family-friendly onlyâ€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 5â€ }
}
}
}
},
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_activitiesâ€,
description: â€œFind things to do AT HOME - crafts, games, rainy day ideas. NOT for days out.â€,
parameters: {
type: â€œobjectâ€,
properties: {
setting: { type: â€œstringâ€, description: â€œINDOOR, OUTDOOR, or CARâ€ },
age: { type: â€œnumberâ€, description: â€œChildâ€™s ageâ€ },
energy: { type: â€œstringâ€, description: â€œLOW, MED, or HIGHâ€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 5â€ }
}
}
}
},
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_productsâ€,
description: â€œSearch products to buy - toys, clothes, gifts, supplies. Use when something would genuinely help their situation.â€,
parameters: {
type: â€œobjectâ€,
properties: {
query: { type: â€œstringâ€, description: â€œSpecific product: binoculars, pyjamas, LEGO, sun hat, snacks, etc.â€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 3â€ }
},
required: [â€œqueryâ€]
}
}
},
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_eventsâ€,
description: â€œFind family events, shows, and live entertainment.â€,
parameters: {
type: â€œobjectâ€,
properties: {
query: { type: â€œstringâ€, description: â€œEvent type or nameâ€ },
city: { type: â€œstringâ€, description: â€œCityâ€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 5â€ }
}
}
}
},
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_restaurantsâ€,
description: â€œFind family-friendly restaurants with kids menus.â€,
parameters: {
type: â€œobjectâ€,
properties: {
city: { type: â€œstringâ€, description: â€œCityâ€ },
chain: { type: â€œstringâ€, description: â€œSpecific chain: Harvester, Beefeater, Toby Carveryâ€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 5â€ }
}
}
}
},
{
type: â€œfunctionâ€,
function: {
name: â€œsearch_recommendationsâ€,
description: â€œGet community-sourced venue recommendations from parent groups.â€,
parameters: {
type: â€œobjectâ€,
properties: {
query: { type: â€œstringâ€, description: â€œVenue or categoryâ€ },
limit: { type: â€œnumberâ€, description: â€œMax results, default 5â€ }
}
}
}
}
];

// ============================================================================
// TOOL EXECUTION - Call your own API endpoints
// ============================================================================

const BASE_URL = `http://localhost:${process.env.PORT || 5000}`;

async function executeTool(name: string, args: Record<string, unknown>): Promise<unknown> {
const limit = (args.limit as number) || 5;

try {
let url: string;

```
switch (name) {
  case "search_attractions":
    url = `${BASE_URL}/attractions/search?query=${encodeURIComponent(args.query as string || "")}&location=${encodeURIComponent(args.location as string || "")}&limit=${limit}`;
    break;
    
  case "search_attractions_free":
    url = `${BASE_URL}/attractions/free?query=${encodeURIComponent(args.query as string || "")}&location=${encodeURIComponent(args.location as string || "")}&limit=${limit}`;
    break;
    
  case "search_cinema":
    url = `${BASE_URL}/cinema/search?family=${args.family !== false}&limit=${limit}`;
    if (args.genre) url += `&genre=${encodeURIComponent(args.genre as string)}`;
    break;
    
  case "search_streaming":
    url = `${BASE_URL}/nightin/search?family=${args.family !== false}&limit=${limit}`;
    if (args.service) url += `&service=${encodeURIComponent(args.service as string)}`;
    if (args.mood) url += `&mood=${encodeURIComponent(args.mood as string)}`;
    break;
    
  case "search_activities":
    url = `${BASE_URL}/activities/search?limit=${limit}`;
    if (args.setting) url += `&setting=${encodeURIComponent(args.setting as string)}`;
    if (args.age) url += `&age=${args.age}`;
    if (args.energy) url += `&energy=${encodeURIComponent(args.energy as string)}`;
    break;
    
  case "search_products":
    url = `${BASE_URL}/shopping/awin-link?query=${encodeURIComponent(args.query as string || "")}&limit=${limit}`;
    break;
    
  case "search_events":
    url = `${BASE_URL}/events/search?limit=${limit}`;
    if (args.query) url += `&query=${encodeURIComponent(args.query as string)}`;
    if (args.city) url += `&city=${encodeURIComponent(args.city as string)}`;
    break;
    
  case "search_restaurants":
    url = `${BASE_URL}/restaurants/search?limit=${limit}`;
    if (args.city) url += `&city=${encodeURIComponent(args.city as string)}`;
    if (args.chain) url += `&chain=${encodeURIComponent(args.chain as string)}`;
    break;
    
  case "search_recommendations":
    url = `${BASE_URL}/recommendations/search?limit=${limit}`;
    if (args.query) url += `&query=${encodeURIComponent(args.query as string)}`;
    break;
    
  default:
    return { error: `Unknown tool: ${name}` };
}

const response = await fetch(url);
const data = await response.json();
return data;
```

} catch (error) {
console.error(`Tool ${name} failed:`, error);
return { error: `Failed to search: ${error}` };
}
}

// ============================================================================
// SPONSOR STRIP - Passive Awin revenue, rotates each session
// ============================================================================

interface SponsorDeal {
merchant: string;
offer: string;
link: string;
}

async function getSponsorStrip(): Promise<SponsorDeal[]> {
try {
// Fetch random products/deals from Awin for the sponsor strip
const categories = [â€œtoysâ€, â€œkidsâ€, â€œfamilyâ€, â€œclothingâ€, â€œgamesâ€];
const randomCategory = categories[Math.floor(Math.random() * categories.length)];

```
const response = await fetch(`${BASE_URL}/shopping/awin-link?query=${randomCategory}&limit=3`);
const data = await response.json();

if (data.results && data.results.length > 0) {
  return data.results.slice(0, 3).map((product: any) => ({
    merchant: product.merchant || "Retailer",
    offer: product.salePrice 
      ? `${Math.round((1 - product.salePrice / product.price) * 100)}% off ${product.name?.substring(0, 30) || "selected items"}`
      : product.name?.substring(0, 40) || "Great deals available",
    link: product.affiliateLink || product.affiliate_link || "#"
  }));
}

// Fallback sponsors if API fails
return [
  { merchant: "Zavvi", offer: "Up to 50% off toys & games", link: "https://www.awin1.com/cread.php?awinmid=599&awinaffid=511345" },
  { merchant: "Debenhams", offer: "Kids clothing sale", link: "https://www.awin1.com/cread.php?awinmid=2228&awinaffid=511345" },
  { merchant: "Wowow Toys", offer: "Free delivery over Â£20", link: "https://www.awin1.com/cread.php?awinmid=19909&awinaffid=511345" }
];
```

} catch (error) {
console.error(â€œSponsor strip fetch failed:â€, error);
return [];
}
}

function formatSponsorStrip(sponsors: SponsorDeal[]): string {
if (sponsors.length === 0) return â€œâ€;

const deals = sponsors.map(s => `${s.merchant}: ${s.offer}`).join(â€ â€¢ â€œ);
return `\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ’° ${deals}`;
}

// ============================================================================
// SESSION MANAGEMENT
// ============================================================================

interface ConversationMessage {
role: â€œuserâ€ | â€œassistantâ€ | â€œsystemâ€;
content: string;
}

interface Session {
id: string;
messages: ConversationMessage[];
createdAt: Date;
lastActivity: Date;
}

const sessions = new Map<string, Session>();

function getOrCreateSession(sessionId?: string): Session {
if (sessionId && sessions.has(sessionId)) {
const session = sessions.get(sessionId)!;
session.lastActivity = new Date();
return session;
}

const newSession: Session = {
id: sessionId || uuidv4(),
messages: [{ role: â€œsystemâ€, content: SYSTEM_PROMPT }],
createdAt: new Date(),
lastActivity: new Date()
};

sessions.set(newSession.id, newSession);
return newSession;
}

// Clean up old sessions every hour
setInterval(() => {
const oneHourAgo = Date.now() - 60 * 60 * 1000;
for (const [id, session] of sessions) {
if (session.lastActivity.getTime() < oneHourAgo) {
sessions.delete(id);
}
}
}, 60 * 60 * 1000);

// ============================================================================
// URL SANITIZATION - Safety net for hallucinated links
// ============================================================================

function sanitizeResponse(text: string): string {
// Remove any fake/example URLs the AI might generate
return text
.replace(/https?://(www.)?(example.com|fake.com|placeholder.com)[^\s)â€]*/gi, â€œ[link removed]â€)
.replace(/https?://(www.)?amazon.(com|co.uk)[^\s)â€]*/gi, â€œ[link removed]â€)
.replace(/[([^]]+)](https?://(www.)?(example|fake|placeholder).[^)]+)/gi, â€œ$1â€);
}

// ============================================================================
// MAIN CHAT HANDLER
// ============================================================================

export async function handleChat(
message: string,
sessionId?: string
): Promise<{ success: boolean; response: string; sessionId: string; sponsorStrip?: string; debug?: unknown }> {

const session = getOrCreateSession(sessionId);
const toolsUsed: { tool: string; args: unknown; resultCount?: number }[] = [];

try {
// Add user message to history
session.messages.push({ role: â€œuserâ€, content: message });

```
// First OpenAI call - let it decide what tools to use
const firstResponse = await openai.chat.completions.create({
  model: "gpt-4o-mini",
  messages: session.messages as OpenAI.Chat.Completions.ChatCompletionMessageParam[],
  tools,
  tool_choice: "auto",
  max_tokens: 1000
});

const firstChoice = firstResponse.choices[0];
let finalResponse: string;

if (firstChoice.message.tool_calls && firstChoice.message.tool_calls.length > 0) {
  // Execute all requested tools
  const toolMessages: OpenAI.Chat.Completions.ChatCompletionMessageParam[] = [
    firstChoice.message as OpenAI.Chat.Completions.ChatCompletionMessageParam
  ];
  
  for (const toolCall of firstChoice.message.tool_calls) {
    const args = JSON.parse(toolCall.function.arguments);
    const result = await executeTool(toolCall.function.name, args);
    
    toolsUsed.push({
      tool: toolCall.function.name,
      args,
      resultCount: Array.isArray((result as any).results) ? (result as any).results.length : undefined
    });
    
    toolMessages.push({
      role: "tool",
      tool_call_id: toolCall.id,
      content: JSON.stringify(result)
    });
  }
  
  // Second OpenAI call - format the results naturally
  const secondResponse = await openai.chat.completions.create({
    model: "gpt-4o-mini",
    messages: [
      ...session.messages as OpenAI.Chat.Completions.ChatCompletionMessageParam[],
      ...toolMessages
    ],
    tools,
    tool_choice: "none", // Prevent infinite tool loops
    max_tokens: 1000
  });
  
  finalResponse = secondResponse.choices[0].message.content || "Sorry, I couldn't find anything for that.";
  
} else {
  // No tools needed - direct response
  finalResponse = firstChoice.message.content || "Sorry, I'm not sure how to help with that.";
}

// Sanitize response
finalResponse = sanitizeResponse(finalResponse);

// Get sponsor strip
const sponsors = await getSponsorStrip();
const sponsorStrip = formatSponsorStrip(sponsors);

// Add to session history
session.messages.push({ role: "assistant", content: finalResponse });

// Trim history if too long (keep last 20 messages + system prompt)
if (session.messages.length > 21) {
  session.messages = [
    session.messages[0], // system prompt
    ...session.messages.slice(-20)
  ];
}

// Log to database
try {
  await db.insert(chatLogs).values({
    id: uuidv4(),
    sessionId: session.id,
    userMessage: message,
    sunnyResponse: finalResponse,
    toolsUsed: JSON.stringify(toolsUsed),
    createdAt: new Date()
  });
} catch (dbError) {
  console.error("Failed to log chat:", dbError);
}

return {
  success: true,
  response: finalResponse,
  sessionId: session.id,
  sponsorStrip,
  debug: {
    version: "v4.0-simplified",
    toolsUsed
  }
};
```

} catch (error) {
console.error(â€œChat error:â€, error);
return {
success: false,
response: â€œSorry, something went wrong. Give me a sec and try again! ğŸ˜Šâ€,
sessionId: session.id,
debug: { error: String(error) }
};
}
}

// ============================================================================
// EXPRESS ROUTES
// ============================================================================

import { Router, Request, Response } from â€œexpressâ€;

export const sunnyRouter = Router();

// Main chat endpoint
sunnyRouter.post(â€/chatâ€, async (req: Request, res: Response) => {
const { message, sessionId } = req.body;

if (!message || typeof message !== â€œstringâ€ || message.trim().length === 0) {
return res.status(400).json({ success: false, error: â€œMessage requiredâ€ });
}

const result = await handleChat(message.trim(), sessionId);
res.json(result);
});

// Health check
sunnyRouter.get(â€/healthâ€, (_req: Request, res: Response) => {
res.json({
status: â€œSunny v4.0 - Simplifiedâ€,
version: â€œv4.0-simplifiedâ€,
activeSessions: sessions.size,
timestamp: new Date().toISOString()
});
});

// Chat history
sunnyRouter.get(â€/historyâ€, async (req: Request, res: Response) => {
try {
const limit = Math.min(parseInt(req.query.limit as string) || 50, 100);
const logs = await db.select().from(chatLogs).limit(limit);

```
res.json({
  success: true,
  count: logs.length,
  logs: logs.map(log => ({
    ...log,
    sunnyResponse: req.query.full === "true" ? log.sunnyResponse : log.sunnyResponse?.substring(0, 100) + "..."
  }))
});
```

} catch (error) {
res.status(500).json({ success: false, error: String(error) });
}
});

// Diagnostics
sunnyRouter.get(â€/diagnosticsâ€, (_req: Request, res: Response) => {
res.json({
version: â€œv4.0-simplifiedâ€,
systemPromptLength: SYSTEM_PROMPT.length,
toolCount: tools.length,
activeSessions: sessions.size,
timestamp: new Date().toISOString()
});
});

export default sunnyRouter;