<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunny Search Quality Audit</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a; color: #e2e8f0; padding: 20px; line-height: 1.5;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #f8fafc; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #94a3b8; margin-bottom: 20px; }
        
        .section { 
            background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        .section h3 { margin-bottom: 15px; color: #f8fafc; font-size: 16px; }
        
        .controls { 
            display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
        }
        button { 
            background: #3b82f6; color: white; border: none; padding: 12px 24px;
            border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #475569; cursor: not-allowed; }
        button.secondary { background: #475569; }
        button.secondary:hover { background: #64748b; }
        button.success { background: #22c55e; }
        button.success:hover { background: #16a34a; }
        button.warning { background: #eab308; color: #0f172a; }
        button.warning:hover { background: #ca8a04; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        button.small { padding: 8px 16px; font-size: 12px; }
        
        select, input { 
            background: #334155; border: 1px solid #475569; color: #e2e8f0;
            padding: 10px 15px; border-radius: 8px; font-size: 14px;
        }
        textarea {
            background: #0f172a; border: 1px solid #475569; color: #e2e8f0;
            padding: 12px; border-radius: 8px; font-size: 13px; font-family: monospace;
            width: 100%; resize: vertical;
        }
        
        .query-editor { margin-bottom: 15px; }
        .query-editor textarea { min-height: 120px; }
        .query-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
        .query-count { color: #94a3b8; font-size: 14px; margin-left: auto; }
        
        .summary { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .stat-card { 
            background: #1e293b; border-radius: 12px; padding: 15px; text-align: center;
        }
        .stat-value { font-size: 32px; font-weight: bold; }
        .stat-label { color: #94a3b8; font-size: 13px; margin-top: 5px; }
        .pass .stat-value { color: #22c55e; }
        .partial .stat-value { color: #eab308; }
        .fail .stat-value { color: #ef4444; }
        .total .stat-value { color: #3b82f6; }
        .speed .stat-value { color: #a855f7; }
        .inventory .stat-value { color: #f97316; }
        
        .progress-section { margin: 20px 0; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-text { font-size: 14px; color: #94a3b8; }
        .eta-text { font-size: 14px; color: #3b82f6; font-weight: 600; }
        
        .progress-bar { 
            background: #334155; border-radius: 8px; height: 12px;
            overflow: hidden; display: flex;
        }
        .progress-pass { background: #22c55e; transition: width 0.3s; }
        .progress-partial { background: #eab308; transition: width 0.3s; }
        .progress-fail { background: #ef4444; transition: width 0.3s; }
        
        progress { 
            width: 100%; height: 8px; border-radius: 4px; margin-top: 8px;
            appearance: none; background: #334155;
        }
        progress::-webkit-progress-bar { background: #334155; border-radius: 4px; }
        progress::-webkit-progress-value { background: #3b82f6; border-radius: 4px; }
        
        .results { background: #1e293b; border-radius: 12px; padding: 20px; }
        .results h2 { margin-bottom: 15px; font-size: 20px; }
        
        .result-item { 
            background: #0f172a; border-radius: 8px; padding: 15px; margin-bottom: 10px;
            border-left: 4px solid #475569;
        }
        .result-item.pass { border-left-color: #22c55e; }
        .result-item.partial { border-left-color: #eab308; }
        .result-item.fail { border-left-color: #ef4444; }
        .result-item.inventory_gap { border-left-color: #f97316; }
        .result-item.speed_bug { border-left-color: #a855f7; }
        .result-item.ranking_bug { border-left-color: #ec4899; }
        .result-item.search_bug { border-left-color: #ef4444; }
        
        .result-header { 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; flex-wrap: wrap; gap: 10px;
        }
        .query-text { font-weight: 600; font-size: 16px; }
        .status-badge { 
            padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
        }
        .status-badge.pass { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-badge.partial { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .status-badge.fail { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status-badge.inventory_gap { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .status-badge.speed_bug { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .status-badge.ranking_bug { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .status-badge.search_bug { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .result-meta { 
            display: flex; gap: 20px; font-size: 13px; color: #94a3b8; margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .result-products { font-size: 13px; }
        .product-tag { 
            display: inline-block; background: #334155; padding: 4px 10px;
            border-radius: 4px; margin: 2px; font-size: 12px;
        }
        .product-tag.relevant { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .product-tag.irrelevant { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .log { 
            background: #0f172a; border-radius: 8px; padding: 15px; margin-top: 15px;
            font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;
        }
        .log-entry { padding: 2px 0; }
        .log-entry.info { color: #3b82f6; }
        .log-entry.success { color: #22c55e; }
        .log-entry.warning { color: #eab308; }
        .log-entry.error { color: #ef4444; }
        
        .filter-row { 
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .filter-row label { color: #94a3b8; font-size: 14px; }
        
        .hidden { display: none; }
        
        .loading { 
            display: flex; align-items: center; gap: 10px; color: #94a3b8;
        }
        .spinner { 
            width: 20px; height: 20px; border: 2px solid #475569;
            border-top-color: #3b82f6; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { 
            padding: 8px 16px; background: #334155; border-radius: 6px; 
            cursor: pointer; font-size: 13px; transition: background 0.2s;
        }
        .tab:hover { background: #475569; }
        .tab.active { background: #3b82f6; }
        
        .file-input { display: none; }
        
        .badge { 
            display: inline-block; background: #334155; padding: 2px 8px;
            border-radius: 4px; font-size: 11px; margin-left: 5px;
        }
        .ai-score {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;
        }
        .ai-score.score-5 { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
        .ai-score.score-4 { background: rgba(52, 211, 153, 0.3); color: #34d399; }
        .ai-score.score-3 { background: rgba(59, 130, 246, 0.3); color: #3b82f6; }
        .ai-score.score-2 { background: rgba(234, 179, 8, 0.3); color: #eab308; }
        .ai-score.score-1 { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
        .ai-score.score-0 { background: rgba(127, 29, 29, 0.5); color: #fca5a5; }
        .ai-score.flagged { background: rgba(220, 38, 38, 0.4); color: #fca5a5; border: 1px solid #dc2626; }
        .ai-reason { font-size: 11px; color: #94a3b8; font-style: italic; margin-left: 8px; }
        .ai-avg { 
            display: inline-block; background: rgba(59, 130, 246, 0.2); 
            color: #60a5fa; padding: 4px 10px; border-radius: 6px; 
            font-weight: 600; font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sunny Search Quality Audit</h1>
        <p class="subtitle" id="subtitleText">Testing search relevance across <strong id="queryCountSubtitle">0</strong> real-world queries</p>
        
        <div class="section">
            <h3>Query Editor <span class="badge" id="queryCount">0 queries</span></h3>
            <div class="query-editor">
                <textarea id="customQueries" rows="10" placeholder="Paste queries here, one per line (supports 2000+ queries)...
Example:
nike trainers
barbie dolls under £30
paw patrol toys for 3 year old
# Lines starting with # are ignored" data-testid="textarea-queries"></textarea>
            </div>
            <div class="query-actions">
                <button onclick="addQueries()" class="success small" data-testid="button-add-queries">Add Queries</button>
                <button onclick="clearQueries()" class="danger small" data-testid="button-clear-queries">Clear All</button>
                <button onclick="loadDefaultQueries()" class="secondary small" data-testid="button-load-defaults">Load Defaults</button>
                <button onclick="exportQueryList()" class="secondary small" data-testid="button-export-queries">Export List</button>
                <button onclick="document.getElementById('importFile').click()" class="secondary small" data-testid="button-import-queries">Import File</button>
                <input type="file" id="importFile" class="file-input" accept=".txt,.json,.csv" onchange="importQueryList(event)">
                <span class="query-count" id="queryCountText">0 queries loaded</span>
            </div>
        </div>
        
        <div class="section">
            <div class="controls">
                <button id="runAudit" data-testid="button-run-audit">Run Full Audit</button>
                <button id="runSample" class="secondary" data-testid="button-run-sample">Run Sample (20)</button>
                <button id="runAiSample" class="success" data-testid="button-run-ai-sample">AI Score Sample (5)</button>
                <button id="pauseResume" class="warning hidden" data-testid="button-pause">Pause</button>
                
                <div class="filter-row">
                    <label>Filter:</label>
                    <select id="categoryFilter" data-testid="select-category">
                        <option value="">All Categories</option>
                        <option value="brand">Brand</option>
                        <option value="character">Character</option>
                        <option value="product">Product Type</option>
                        <option value="age">Age Specific</option>
                        <option value="budget">Budget</option>
                        <option value="cinema">Cinema/Movies</option>
                        <option value="attraction">Attractions</option>
                    </select>
                </div>
                
                <div class="filter-row">
                    <label>Show:</label>
                    <select id="statusFilter" data-testid="select-status">
                        <option value="">All Results</option>
                        <option value="pass">Pass Only</option>
                        <option value="partial">Partial Only</option>
                        <option value="fail">Failures Only</option>
                        <option value="inventory_gap">Inventory Gaps</option>
                        <option value="speed_bug">Speed Bugs</option>
                        <option value="search_bug">Search Bugs</option>
                        <option value="ranking_bug">Ranking Bugs</option>
                    </select>
                </div>
                
                <button id="downloadResults" class="secondary" data-testid="button-download">Download CSV</button>
            </div>
        </div>
        
        <div class="summary">
            <div class="stat-card total">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card pass">
                <div class="stat-value" id="passCount">0</div>
                <div class="stat-label">Pass</div>
            </div>
            <div class="stat-card partial">
                <div class="stat-value" id="partialCount">0</div>
                <div class="stat-label">Partial</div>
            </div>
            <div class="stat-card inventory">
                <div class="stat-value" id="inventoryCount">0</div>
                <div class="stat-label">Inventory Gap</div>
            </div>
            <div class="stat-card speed">
                <div class="stat-value" id="speedCount">0</div>
                <div class="stat-label">Speed Bug</div>
            </div>
            <div class="stat-card fail">
                <div class="stat-value" id="failCount">0</div>
                <div class="stat-label">Other Fails</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="passRate">-</div>
                <div class="stat-label">Pass Rate</div>
            </div>
        </div>
        
        <div class="progress-section">
            <div class="progress-header">
                <span class="progress-text" id="progressText">0 / 0 queries</span>
                <span class="eta-text" id="etaText">ETA: --</span>
            </div>
            <progress id="progressBar" value="0" max="100"></progress>
        </div>
        
        <div class="progress-bar">
            <div class="progress-pass" id="progressPass" style="width: 0%"></div>
            <div class="progress-partial" id="progressPartial" style="width: 0%"></div>
            <div class="progress-fail" id="progressFail" style="width: 0%"></div>
        </div>
        
        <div class="log" id="log">
            <div class="log-entry info">Ready to run audit. Add queries and click "Run Full Audit" to start.</div>
        </div>
        
        <div class="results" id="results">
            <h2>Results <span id="resultCount"></span></h2>
            <div id="resultsList"></div>
        </div>
    </div>
    
    <script>
        let testQueries = [];
        let allResults = [];
        let isRunning = false;
        let isPaused = false;
        let currentIndex = 0;
        let startTime = null;
        let pausedQueries = [];
        
        const STORAGE_KEY = 'sunnyAuditQueries';
        const RESULTS_KEY = 'sunnyAuditResults';
        const PROGRESS_KEY = 'sunnyAuditProgress';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function saveQueries() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(testQueries));
            updateQueryCount();
        }
        
        function loadSavedQueries() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    testQueries = JSON.parse(saved);
                    log(`Loaded ${testQueries.length} queries from local storage`, 'success');
                } catch (e) {
                    testQueries = [];
                }
            }
            updateQueryCount();
        }
        
        let runQueries = [];
        
        function saveProgress() {
            const elapsed = startTime ? Date.now() - startTime : 0;
            localStorage.setItem(PROGRESS_KEY, JSON.stringify({
                currentIndex,
                allResults,
                queries: runQueries,
                elapsed,
                timestamp: Date.now()
            }));
        }
        
        function loadProgress() {
            const saved = localStorage.getItem(PROGRESS_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        return data;
                    }
                } catch (e) {}
            }
            return null;
        }
        
        function clearProgress() {
            localStorage.removeItem(PROGRESS_KEY);
        }
        
        function updateQueryCount() {
            const count = testQueries.length;
            document.getElementById('queryCount').textContent = `${count} queries`;
            document.getElementById('queryCountText').textContent = `${count.toLocaleString()} queries loaded`;
            document.getElementById('queryCountSubtitle').textContent = count.toLocaleString();
        }
        
        function addQueries() {
            const textarea = document.getElementById('customQueries');
            const newQueries = textarea.value
                .split('\n')
                .map(q => q.trim())
                .filter(q => q.length > 0 && !q.startsWith('#'));
            
            if (newQueries.length === 0) {
                log('No valid queries to add. Check your input.', 'warning');
                return;
            }
            
            const combined = [...new Set([...testQueries, ...newQueries])];
            const added = combined.length - testQueries.length;
            testQueries = combined;
            saveQueries();
            updateQueryCount();
            textarea.value = '';
            log(`Added ${added} new queries (${newQueries.length - added} duplicates skipped). Total: ${testQueries.length.toLocaleString()}`, 'success');
        }
        
        function clearQueries() {
            if (confirm('Clear all queries? This cannot be undone.')) {
                testQueries = [];
                saveQueries();
                updateQueryCount();
                log('All queries cleared', 'warning');
            }
        }
        
        async function loadDefaultQueries() {
            try {
                const res = await fetch('/api/audit/queries');
                const data = await res.json();
                const serverQueries = data.queries || [];
                
                const before = testQueries.length;
                testQueries = [...new Set([...testQueries, ...serverQueries])];
                saveQueries();
                updateQueryCount();
                log(`Loaded ${testQueries.length - before} default queries. Total: ${testQueries.length.toLocaleString()}`, 'success');
            } catch (e) {
                log(`Failed to load defaults: ${e.message}`, 'error');
            }
        }
        
        function exportQueryList() {
            if (testQueries.length === 0) {
                alert('No queries to export.');
                return;
            }
            const content = testQueries.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit-queries-${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            log(`Exported ${testQueries.length} queries`, 'success');
        }
        
        function importQueryList(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                let queries = [];
                
                if (file.name.endsWith('.json')) {
                    try {
                        queries = JSON.parse(content);
                        if (!Array.isArray(queries)) queries = [];
                    } catch (err) {
                        log('Invalid JSON file', 'error');
                        return;
                    }
                } else {
                    queries = content
                        .split('\n')
                        .map(q => q.trim())
                        .filter(q => q.length > 0 && !q.startsWith('#'));
                }
                
                const before = testQueries.length;
                testQueries = [...new Set([...testQueries, ...queries])];
                const added = testQueries.length - before;
                saveQueries();
                updateQueryCount();
                log(`Imported ${added} queries from ${file.name} (${queries.length - added} duplicates skipped). Total: ${testQueries.length.toLocaleString()}`, 'success');
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function categorizeVerdict(result) {
            const timeMs = result.search_result?.time_ms || 0;
            const dbCount = result.database_check?.count || 0;
            const searchCount = result.search_result?.count || 0;
            const relevance = result.analysis?.relevance_score || 0;
            const hasImages = result.analysis?.image_percent || 0;
            
            if (timeMs > 10000) return 'SPEED_BUG';
            if (dbCount === 0) return 'INVENTORY_GAP';
            if (dbCount > 0 && searchCount === 0) return 'SEARCH_BUG';
            if (relevance >= 0.8) return 'PASS';
            if (relevance >= 0.5) return 'PARTIAL';
            if (relevance < 0.3 && searchCount > 0) return 'RANKING_BUG';
            return 'FAIL';
        }
        
        function getFixAction(verdict, result) {
            switch (verdict) {
                case 'SPEED_BUG': return 'Add fast-path pattern or optimize query';
                case 'INVENTORY_GAP': return 'Import products for this brand/category';
                case 'SEARCH_BUG': return 'Debug search algorithm - DB has products but none returned';
                case 'RANKING_BUG': return 'Improve relevance scoring/reranker';
                case 'PARTIAL': return 'Review search term expansion';
                default: return '';
            }
        }
        
        function updateStats() {
            const stats = { pass: 0, partial: 0, fail: 0, inventory: 0, speed: 0, ranking: 0, search: 0 };
            
            for (const r of allResults) {
                const verdict = r.verdict || categorizeVerdict(r);
                switch (verdict) {
                    case 'PASS': stats.pass++; break;
                    case 'PARTIAL': stats.partial++; break;
                    case 'INVENTORY_GAP': stats.inventory++; break;
                    case 'SPEED_BUG': stats.speed++; break;
                    case 'RANKING_BUG': stats.ranking++; break;
                    case 'SEARCH_BUG': stats.search++; break;
                    default: stats.fail++;
                }
            }
            
            const total = allResults.length || 1;
            document.getElementById('totalCount').textContent = allResults.length;
            document.getElementById('passCount').textContent = stats.pass;
            document.getElementById('partialCount').textContent = stats.partial;
            document.getElementById('inventoryCount').textContent = stats.inventory;
            document.getElementById('speedCount').textContent = stats.speed;
            document.getElementById('failCount').textContent = stats.fail + stats.ranking + stats.search;
            document.getElementById('passRate').textContent = Math.round(stats.pass / total * 100) + '%';
            
            document.getElementById('progressPass').style.width = (stats.pass / total * 100) + '%';
            document.getElementById('progressPartial').style.width = (stats.partial / total * 100) + '%';
            document.getElementById('progressFail').style.width = ((stats.fail + stats.inventory + stats.speed + stats.ranking + stats.search) / total * 100) + '%';
        }
        
        function updateProgress(current, total) {
            document.getElementById('progressText').textContent = `${current} / ${total} queries`;
            document.getElementById('progressBar').value = current;
            document.getElementById('progressBar').max = total;
            
            if (startTime && current > 0) {
                const elapsed = Date.now() - startTime;
                const avgTime = elapsed / current;
                const remaining = (total - current) * avgTime;
                const etaMinutes = Math.ceil(remaining / 60000);
                document.getElementById('etaText').textContent = `ETA: ${etaMinutes} min`;
            }
        }
        
        function getAiScoreClass(score) {
            if (score === undefined || score === null) return 'score-0';
            if (score < 0) return 'score-0';
            if (score >= 5) return 'score-5';
            if (score >= 4) return 'score-4';
            if (score >= 3) return 'score-3';
            if (score >= 2) return 'score-2';
            if (score >= 1) return 'score-1';
            return 'score-0';
        }
        
        function renderResult(result) {
            const verdict = result.verdict || categorizeVerdict(result);
            const statusSlug = verdict.toLowerCase();
            const products = result.search_result?.products || [];
            const hasAiScoring = result.analysis?.ai_avg_score !== undefined;
            
            return `
                <div class="result-item ${statusSlug}" data-category="${result.category || ''}" data-status="${statusSlug}">
                    <div class="result-header">
                        <span class="query-text">${result.query}</span>
                        ${hasAiScoring && !result.analysis.ai_scoring_failed ? 
                            `<span class="ai-avg">AI: ${result.analysis.ai_avg_score}/5</span>` : 
                            (result.analysis.ai_scoring_failed ? `<span class="ai-avg" style="background:rgba(239,68,68,0.2);color:#ef4444">AI: ERROR</span>` : '')}
                        <span class="status-badge ${statusSlug}">${verdict}</span>
                    </div>
                    <div class="result-meta">
                        <span>DB: ${result.database_check?.count || 0} products</span>
                        <span>Returned: ${result.search_result?.count || 0}</span>
                        <span>Relevant: ${Math.round((result.analysis?.relevance_score || 0) * 100)}%</span>
                        ${hasAiScoring && result.analysis.ai_flagged_count > 0 ? `<span style="color:#ef4444">Flagged: ${result.analysis.ai_flagged_count}</span>` : ''}
                        <span>Time: ${result.search_result?.time_ms || 0}ms</span>
                    </div>
                    <div class="result-products">
                        ${products.slice(0, 10).map((p, idx) => `
                            <div style="display:flex; align-items:center; gap:8px; margin:4px 0; padding:6px; background:#1e293b; border-radius:6px;">
                                <span style="color:#64748b; font-size:12px; width:20px;">${idx + 1}.</span>
                                ${p.aiScore !== undefined && p.aiScore !== null ? `
                                    <span class="ai-score ${getAiScoreClass(p.aiScore)} ${p.flagged ? 'flagged' : ''}">${p.aiScore < 0 ? 'ERR' : p.aiScore}</span>
                                ` : ''}
                                <span class="product-tag ${p.relevant ? 'relevant' : 'irrelevant'}" style="flex:1; margin:0;">
                                    ${(p.name || '').substring(0, 50)}${(p.name || '').length > 50 ? '...' : ''} - £${Number(p.price || 0).toFixed(2)}
                                </span>
                                ${p.aiReason ? `<span class="ai-reason">${p.aiReason}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderResults() {
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            const filtered = allResults.filter(r => {
                const verdict = (r.verdict || categorizeVerdict(r)).toLowerCase();
                if (category && !(r.category || '').includes(category)) return false;
                if (status && verdict !== status) return false;
                return true;
            });
            
            document.getElementById('resultCount').textContent = `(${filtered.length} shown)`;
            document.getElementById('resultsList').innerHTML = filtered.map(renderResult).join('');
        }
        
        let useAiScoring = false;
        
        async function runAudit(queries, resumeFrom = 0, enableAiScoring = false) {
            useAiScoring = enableAiScoring;
            
            if (queries.length === 0) {
                log('No queries to run. Add some queries first.', 'warning');
                return;
            }
            
            const btn = document.getElementById('runAudit');
            const sampleBtn = document.getElementById('runSample');
            const aiSampleBtn = document.getElementById('runAiSample');
            const pauseBtn = document.getElementById('pauseResume');
            
            isRunning = true;
            isPaused = false;
            btn.disabled = true;
            sampleBtn.disabled = true;
            aiSampleBtn.disabled = true;
            pauseBtn.classList.remove('hidden');
            pauseBtn.textContent = 'Pause';
            pauseBtn.className = 'warning';
            btn.innerHTML = useAiScoring ? 
                '<span class="loading"><span class="spinner"></span> AI Scoring...</span>' :
                '<span class="loading"><span class="spinner"></span> Running...</span>';
            
            if (resumeFrom === 0) {
                startTime = Date.now();
            }
            
            log(`Starting audit with ${queries.length} queries from index ${resumeFrom}...`);
            
            const batchSize = 5;
            
            for (let i = resumeFrom; i < queries.length && isRunning; i += batchSize) {
                while (isPaused && isRunning) {
                    currentIndex = i;
                    saveProgress();
                    await new Promise(r => setTimeout(r, 250));
                }
                
                if (!isRunning) break;
                
                const batch = queries.slice(i, Math.min(i + batchSize, queries.length));
                updateProgress(i, queries.length);
                
                try {
                    const res = await fetch('/api/audit/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            queries: batch, 
                            check_relevance: true, 
                            limit: 10,
                            use_ai_scoring: useAiScoring
                        })
                    });
                    const data = await res.json();
                    
                    if (data.results) {
                        for (const r of data.results) {
                            r.verdict = categorizeVerdict(r);
                            allResults.push(r);
                            
                            const logType = r.verdict === 'PASS' ? 'success' : 
                                           r.verdict === 'PARTIAL' ? 'warning' : 'error';
                            log(`${r.query}: ${r.verdict} (${r.search_result?.count || 0} results, ${r.search_result?.time_ms || 0}ms)`, logType);
                        }
                        
                        currentIndex = Math.min(i + batchSize, queries.length);
                        saveProgress();
                        updateStats();
                        renderResults();
                    }
                } catch (e) {
                    log(`Batch failed: ${e.message}`, 'error');
                }
            }
            
            updateProgress(queries.length, queries.length);
            clearProgress();
            
            const elapsed = Math.round((Date.now() - startTime) / 1000);
            log(`Audit complete in ${elapsed}s! Total: ${allResults.length}`, 'success');
            
            isRunning = false;
            useAiScoring = false;
            btn.disabled = false;
            sampleBtn.disabled = false;
            aiSampleBtn.disabled = false;
            pauseBtn.classList.add('hidden');
            btn.textContent = 'Run Full Audit';
        }
        
        function resumeFromProgress() {
            const progress = loadProgress();
            if (progress && typeof progress.currentIndex === 'number' && progress.allResults && progress.queries) {
                currentIndex = progress.currentIndex;
                allResults = progress.allResults;
                runQueries = progress.queries;
                startTime = Date.now() - (progress.elapsed || 0);
                updateStats();
                renderResults();
                log(`Resuming from query ${currentIndex}/${runQueries.length}...`, 'info');
                runAudit(runQueries, currentIndex);
            }
        }
        
        function togglePause() {
            const pauseBtn = document.getElementById('pauseResume');
            
            if (!isRunning) {
                resumeFromProgress();
                return;
            }
            
            isPaused = !isPaused;
            
            if (isPaused) {
                pauseBtn.textContent = 'Resume';
                pauseBtn.className = 'success';
                log(`Paused at query ${currentIndex}/${runQueries.length}. Click Resume to continue.`, 'warning');
            } else {
                pauseBtn.textContent = 'Pause';
                pauseBtn.className = 'warning';
                log(`Resuming...`, 'info');
            }
        }
        
        function downloadCSV() {
            if (allResults.length === 0) {
                alert('No results to download. Run an audit first.');
                return;
            }
            
            const headers = [
                'query', 'verdict', 'dbCount', 'searchCount', 'relevancePercent', 
                'imagePercent', 'timeMs', 'firstResult', 'category', 'fixAction'
            ];
            
            const rows = allResults.map(r => {
                const verdict = r.verdict || categorizeVerdict(r);
                const firstProduct = r.search_result?.products?.[0];
                return [
                    `"${(r.query || '').replace(/"/g, '""')}"`,
                    verdict,
                    r.database_check?.count || 0,
                    r.search_result?.count || 0,
                    Math.round((r.analysis?.relevance_score || 0) * 100),
                    Math.round((r.analysis?.image_percent || 0) * 100),
                    r.search_result?.time_ms || 0,
                    `"${(firstProduct?.name || '').replace(/"/g, '""').substring(0, 50)}"`,
                    r.category || '',
                    `"${getFixAction(verdict, r)}"`
                ];
            });
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit-results-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            log(`Downloaded ${allResults.length} results as CSV`, 'success');
        }
        
        function shuffleArray(arr) {
            const copy = [...arr];
            for (let i = copy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [copy[i], copy[j]] = [copy[j], copy[i]];
            }
            return copy;
        }
        
        document.getElementById('runAudit').addEventListener('click', () => {
            if (testQueries.length === 0) {
                log('No queries loaded. Add queries or load defaults first.', 'warning');
                return;
            }
            clearProgress();
            allResults = [];
            runQueries = [...testQueries];
            currentIndex = 0;
            runAudit(runQueries, 0, false);
        });
        
        document.getElementById('runSample').addEventListener('click', () => {
            if (testQueries.length === 0) {
                log('No queries loaded. Add queries or load defaults first.', 'warning');
                return;
            }
            clearProgress();
            allResults = [];
            runQueries = shuffleArray(testQueries).slice(0, 20);
            currentIndex = 0;
            runAudit(runQueries, 0, false);
        });
        
        document.getElementById('runAiSample').addEventListener('click', () => {
            if (testQueries.length === 0) {
                log('No queries loaded. Add queries or load defaults first.', 'warning');
                return;
            }
            clearProgress();
            allResults = [];
            runQueries = shuffleArray(testQueries).slice(0, 5);
            currentIndex = 0;
            log('Running AI-powered relevance scoring (GPT-4o-mini)...', 'info');
            runAudit(runQueries, 0, true);
        });
        
        document.getElementById('pauseResume').addEventListener('click', togglePause);
        document.getElementById('categoryFilter').addEventListener('change', renderResults);
        document.getElementById('statusFilter').addEventListener('change', renderResults);
        document.getElementById('downloadResults').addEventListener('click', downloadCSV);
        
        loadSavedQueries();
        
        const savedProgress = loadProgress();
        if (savedProgress && savedProgress.allResults && savedProgress.allResults.length > 0 && savedProgress.queries) {
            allResults = savedProgress.allResults;
            runQueries = savedProgress.queries;
            currentIndex = savedProgress.currentIndex || 0;
            startTime = Date.now() - (savedProgress.elapsed || 0);
            updateStats();
            renderResults();
            log(`PAUSED RUN FOUND: ${currentIndex}/${runQueries.length} queries completed. Click Resume to continue.`, 'warning');
            document.getElementById('pauseResume').classList.remove('hidden');
            document.getElementById('pauseResume').textContent = 'Resume Previous Run';
            document.getElementById('pauseResume').className = 'success';
        }
    </script>
</body>
</html>
