<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunny API Stress Test</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #f9a825; text-align: center; }
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #startBtn { background: #4CAF50; color: white; }
        #stopBtn { background: #f44336; color: white; }
        #downloadBtn { background: #2196F3; color: white; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-box h3 { margin: 0; color: #888; font-size: 14px; }
        .stat-box .value { font-size: 32px; color: #f9a825; margin-top: 10px; }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #16213e;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f9a825, #ff6b6b);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }
        #results {
            background: #16213e;
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result-row {
            display: grid;
            grid-template-columns: 50px 1fr 100px 80px 80px;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #333;
            font-size: 14px;
        }
        .result-row.header {
            font-weight: bold;
            color: #f9a825;
            position: sticky;
            top: 0;
            background: #16213e;
        }
        .result-row.success { color: #4CAF50; }
        .result-row.error { color: #f44336; }
        .result-row.slow { color: #ff9800; }
        input[type="number"] {
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            width: 100px;
            text-align: center;
        }
        label { display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>
    <h1>Sunny API Stress Test</h1>
    
    <div class="controls">
        <label>
            Queries to run:
            <input type="number" id="queryCount" value="500" min="1" max="1000">
        </label>
        <label>
            Delay (ms):
            <input type="number" id="delayMs" value="200" min="50" max="2000">
        </label>
        <button id="startBtn" onclick="startTest()">Start Test</button>
        <button id="stopBtn" onclick="stopTest()" disabled>Stop</button>
        <button id="downloadBtn" onclick="downloadCSV()" disabled>Download CSV</button>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" id="progress" style="width: 0%">0%</div>
    </div>

    <div class="stats">
        <div class="stat-box">
            <h3>Completed</h3>
            <div class="value" id="completed">0</div>
        </div>
        <div class="stat-box">
            <h3>Success</h3>
            <div class="value" id="success">0</div>
        </div>
        <div class="stat-box">
            <h3>Errors</h3>
            <div class="value" id="errors">0</div>
        </div>
        <div class="stat-box">
            <h3>Avg Time</h3>
            <div class="value" id="avgTime">0ms</div>
        </div>
        <div class="stat-box">
            <h3>Avg Products</h3>
            <div class="value" id="avgProducts">0</div>
        </div>
    </div>

    <div id="results">
        <div class="result-row header">
            <span>#</span>
            <span>Query</span>
            <span>Products</span>
            <span>Time</span>
            <span>Status</span>
        </div>
    </div>

    <script>
        // Always test Railway production server
        const API_BASE = 'https://gpt-newdeals-production.up.railway.app';
        
        // Real conversational queries from Sunny search quality audit
        const queries = [
            // Specific product searches with size/color
            "nike air force 1 white size 10",
            "blue paw patrol wellies size 9",
            "clarks school shoes size 13",
            "adidas trainers size 5 kids",
            "converse high tops white size 4",
            "vans old skool black size 6",
            "crocs size 11 kids blue",
            "clarks first shoes size 4",
            "kickers school shoes size 1",
            "nike dunk low white size 8",
            
            // Semantic gift searches with context
            "something for a 3 year old who loves dinosaurs under £15",
            "birthday present for 7 year old girl who likes unicorns",
            "gift for 5 year old boy obsessed with cars",
            "present for 8 year old who loves science",
            "something for a toddler who likes animals",
            "gift for 10 year old gamer",
            "birthday present for 6 year old who likes superheroes",
            "christmas gift for 4 year old who loves dolls",
            "present for 9 year old who likes crafts",
            "gift for teenager who likes music",
            
            // Price-constrained searches
            "lego star wars under £30",
            "sensory toys for autistic child under £20",
            "toys under £10 for party bags",
            "gifts under £15 for kids",
            "educational toys under £25",
            "outdoor toys under £50",
            "birthday present under £20",
            "stocking fillers under £5",
            "craft supplies under £15",
            "books for kids under £10",
            
            // Specific brand + product combinations
            "minecraft duvet cover single bed",
            "wooden train set compatible with brio",
            "peppa pig backpack for nursery",
            "paw patrol tower playset",
            "lego duplo farm set",
            "barbie dreamhouse accessories",
            "pokemon cards booster box",
            "hot wheels track builder",
            "sylvanian families house",
            "playmobil police station",
            
            // Contextual shopping needs
            "rainy day activities for 5 year old",
            "car journey toys for toddler",
            "quiet toys for plane journey",
            "garden toys for summer",
            "bath toys for baby",
            "bedtime story books age 4",
            "first day of school supplies",
            "birthday party supplies unicorn theme",
            "world book day costume ideas",
            "easter basket fillers for kids",
            
            // Specific age + gender combinations
            "toys for 2 year old boy who likes trucks",
            "gifts for 6 year old girl who likes art",
            "present for 11 year old boy into football",
            "birthday ideas for 3 year old girl",
            "christmas presents for 8 year old boy",
            "easter gifts for toddler girl",
            "stocking fillers for 7 year old",
            "party bag toys for 5 year olds",
            "travel toys for 4 year old",
            "garden games for 10 year old",
            
            // Clothing with specifics
            "girls school uniform age 7",
            "boys winter coat age 5",
            "kids waterproof jacket age 8",
            "girls party dress age 6",
            "boys football kit age 9",
            "kids pyjamas age 4",
            "school pe kit boys age 7",
            "girls swimsuit age 5",
            "boys shorts age 6",
            "kids wellies size 10",
            
            // Home and room items
            "kids single duvet cover dinosaurs",
            "boys bedroom curtains blue",
            "girls rug pink fluffy",
            "kids bookshelf white",
            "toy storage boxes stackable",
            "night light projector stars",
            "kids desk and chair set",
            "bean bag for kids room",
            "kids wall stickers space",
            "blackout blinds for nursery",
            
            // Educational and developmental
            "phonics books reception age",
            "times tables games for kids",
            "coding toys for beginners",
            "science experiments kit age 8",
            "geography puzzle world map",
            "reading books for reluctant readers",
            "maths games for year 2",
            "spelling practice for kids",
            "handwriting practice books",
            "educational apps tablet",
            
            // Baby and toddler specific
            "teething toys 6 months",
            "baby walker push along",
            "toddler ride on toys",
            "stacking cups for babies",
            "sensory play items baby",
            "first birthday gift ideas",
            "weaning supplies starter kit",
            "baby bath toys floating",
            "toddler puzzles wooden",
            "baby gym play mat",
            
            // Sports and outdoor
            "kids football size 3",
            "garden trampoline 8ft",
            "bike stabilisers 14 inch",
            "swimming armbands age 3",
            "kids tennis racket",
            "goal posts for garden",
            "scooter for 6 year old",
            "roller skates adjustable kids",
            "basketball hoop freestanding",
            "cricket set for garden",
            
            // Arts and crafts
            "paint set for kids",
            "kids easel double sided",
            "clay modelling kit",
            "jewellery making set girls",
            "origami paper for beginners",
            "sewing kit for kids",
            "tie dye kit clothes",
            "rock painting kit",
            "candle making set kids",
            "slime making kit glitter",
            
            // Character-based searches
            "frozen elsa costume age 5",
            "spiderman toys action figure",
            "bluey toys plush",
            "paw patrol chase toy",
            "peppa pig house playset",
            "pokemon plush large",
            "mario kart toys",
            "sonic the hedgehog figures",
            "cocomelon jj doll",
            "hey duggee toys squirrels",
            
            // Problem-solving searches
            "toys to help with fine motor skills",
            "calm down toys for anxiety",
            "fidget toys for school",
            "toys for long car journeys",
            "quiet toys for restaurants",
            "independent play toys toddler",
            "screen free activities kids",
            "boredom busters for kids",
            "toys that encourage sharing",
            "confidence building toys",
            
            // Seasonal and occasion
            "halloween costume witch age 7",
            "christmas eve box fillers",
            "advent calendar chocolate",
            "easter egg hunt supplies",
            "bonfire night sparklers",
            "summer holiday toys",
            "back to school essentials",
            "mothers day gift from kids",
            "fathers day present handmade",
            "valentines cards for class",
            
            // Tech and gadgets
            "kids tablet with parental controls",
            "walkie talkies long range kids",
            "kids camera waterproof",
            "headphones for children",
            "karaoke machine bluetooth",
            "drone for kids beginner",
            "vtech watch for kids",
            "nintendo switch case",
            "gaming headset for kids",
            "kids projector for bedroom",
            "free delivery toys", "sale toys", "clearance toys",
            "best toys 2024", "award winning toys", "top toys christmas",
            "most popular toys", "trending toys", "viral toys tiktok",
            "what to buy 5 year old birthday", "best gift for toddler",
            "toys that keep kids busy", "educational gift ideas",
            "screen free toys", "toys without batteries",
            "quiet toys", "toys for car journeys",
            "toys for waiting rooms", "toys for restaurants",
            "pocket money toys", "party bag fillers",
            "prizes for kids", "reward chart", "sticker chart",
            "present ideas", "gift ideas kids", "toy recommendations",
            "best selling toys", "new toys", "classic toys",
            "retro toys", "80s toys", "90s toys",
            "nostalgic toys", "toys parents love", "annoying toys",
            "quiet toys grandparents house", "toys for grandparents house",
            "travel size toys", "compact toys", "foldable toys",
            "inflatable toys", "ride on toys", "sit on toys",
            "push along toys", "pull along toys", "shape sorter",
            "stacking toys", "nesting toys", "threading toys",
            "lacing toys", "peg board", "hammer bench",
            "marble run", "ball run", "domino set kids",
            "magic set", "science experiments", "volcano kit",
            "crystal growing kit", "bug catcher", "nature kit",
            "gardening kit kids", "bird house kit", "fairy garden kit",
            "den building kit", "fort kit", "teepee kids",
            "play tent", "tunnel kids", "ball pit", "foam pit",
            "crash mat", "gymnastics mat", "yoga mat kids",
            "exercise equipment kids", "kids fitness", "dance mat",
            "karaoke", "disco ball kids", "party lights kids"
        ];

        let results = [];
        let running = false;
        let completed = 0;
        let successCount = 0;
        let errorCount = 0;
        let totalTime = 0;
        let totalProducts = 0;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function runQuery(query, index) {
            const startTime = Date.now();
            try {
                const response = await fetch(`${API_BASE}/shopping/awin-link?query=${encodeURIComponent(query)}&limit=9`);
                const data = await response.json();
                const elapsed = Date.now() - startTime;
                
                const productCount = data.results ? data.results.length : (data.products ? data.products.length : 0);
                
                return {
                    index: index + 1,
                    query,
                    products: productCount,
                    time: elapsed,
                    status: 'success',
                    data
                };
            } catch (error) {
                return {
                    index: index + 1,
                    query,
                    products: 0,
                    time: Date.now() - startTime,
                    status: 'error',
                    error: error.message
                };
            }
        }

        function updateStats() {
            document.getElementById('completed').textContent = completed;
            document.getElementById('success').textContent = successCount;
            document.getElementById('errors').textContent = errorCount;
            document.getElementById('avgTime').textContent = completed > 0 ? Math.round(totalTime / completed) + 'ms' : '0ms';
            document.getElementById('avgProducts').textContent = successCount > 0 ? (totalProducts / successCount).toFixed(1) : '0';
            
            const total = parseInt(document.getElementById('queryCount').value);
            const percent = Math.round((completed / total) * 100);
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('progress').textContent = percent + '%';
        }

        function addResultRow(result) {
            const container = document.getElementById('results');
            const row = document.createElement('div');
            row.className = `result-row ${result.status} ${result.time > 2000 ? 'slow' : ''}`;
            row.innerHTML = `
                <span>${result.index}</span>
                <span>${result.query}</span>
                <span>${result.products}</span>
                <span>${result.time}ms</span>
                <span>${result.status}</span>
            `;
            container.appendChild(row);
            container.scrollTop = container.scrollHeight;
        }

        async function startTest() {
            const total = parseInt(document.getElementById('queryCount').value);
            const delay = parseInt(document.getElementById('delayMs').value);
            
            results = [];
            completed = 0;
            successCount = 0;
            errorCount = 0;
            totalTime = 0;
            totalProducts = 0;
            running = true;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = true;
            
            const container = document.getElementById('results');
            container.innerHTML = `<div class="result-row header">
                <span>#</span>
                <span>Query</span>
                <span>Products</span>
                <span>Time</span>
                <span>Status</span>
            </div>`;
            
            const testQueries = shuffle([...queries]).slice(0, total);
            
            for (let i = 0; i < testQueries.length && running; i++) {
                const result = await runQuery(testQueries[i], i);
                results.push(result);
                
                completed++;
                totalTime += result.time;
                
                if (result.status === 'success') {
                    successCount++;
                    totalProducts += result.products;
                } else {
                    errorCount++;
                }
                
                addResultRow(result);
                updateStats();
                
                if (i < testQueries.length - 1 && running) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            running = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = false;
        }

        function stopTest() {
            running = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = false;
        }

        function downloadCSV() {
            const headers = ['Index', 'Query', 'Products Found', 'Response Time (ms)', 'Status'];
            const rows = results.map(r => [r.index, `"${r.query}"`, r.products, r.time, r.status]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sunny-stress-test-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }
    </script>
</body>
</html>
